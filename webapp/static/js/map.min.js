$(document).ready(function(){OpenRIS.regionLoad();OpenRIS.post_region_change=function(){$.geosearchbox.settings.url="/api/locations?r="+OpenRIS.region.id;$.papersearchbox.settings.url="/api/papers-live?r="+OpenRIS.region.id;b.setView(new L.LatLng(OpenRIS.region.lat,OpenRIS.region.lon),OpenRIS.region.zoom).addLayer(m);window.history.pushState(String(Date.now()),document.title,"/?r="+OpenRIS.region.id);if($("#search-examples")){$("#search-examples").html("");$("#search-examples").append(document.createTextNode("Beispiele: "));$.each(OpenRIS.region.keyword,function(p,o){$("<a/>").text(o).attr({href:"/suche?r="+OpenRIS.region.id+"&q="+encodeURI(o)}).appendTo("#search-examples");if(OpenRIS.region.keyword.length>p+1){$("#search-examples").append(document.createTextNode(", "))}})}$("#qinput-region").val(OpenRIS.region.id);f()};var b=new L.Map("map",{});var d=new L.LayerGroup();b.addLayer(d);var m=new L.TileLayer(CONF.mapTileUrlSchema,{maxZoom:CONF.mapTileMaxZoom,minZoom:CONF.mapTileMinZoom,attribution:CONF.mapTileAttribution});var j={};var a="";b.setView(new L.LatLng(OpenRIS.region.lat,OpenRIS.region.lon),OpenRIS.region.zoom).addLayer(m);if(search_data.address){$("#address").val(search_data.address);l()}OpenRIS.loadGeoLiveSearch();$("<p>").attr("id","address-live").css({top:$("#address").height(),width:$("#address").width()}).appendTo($("#address-box"));$("#address").geosearchbox({url:"/api/locations?r="+OpenRIS.region.id,param:"l",show_results:function(o){o=o.response;result_html="<ul>";if(o.length){$("#address-live").css({display:"block"});for(i=0;i<o.length;i++){result_html+='<li data-point="'+o[i]["point"]+'">'+o[i]["name"]+", ";if(o[i].hasOwnProperty("postalcode")){result_html+=o[i]["postalcode"]+" "}result_html+=o[i]["bodyName"]+"</li>"}result_html+="</ul>";$("#address-live").html(result_html);$("#address-live li").click(function(){point=$(this).attr("data-point");point=point.split(",");search_data.lat=point[0];search_data.lon=point[1];$("#address").val($(this).text());$("#address-live").css({display:"none"});$("#position-prompt-submit").trigger("click")})}else{$("#address-live").css({display:"none"})}}});var e=$("#position-prompt");if(e.length>0){$("#address").focus()}$("#position-prompt-submit").click(function(o){o.preventDefault();l()});$("#position-prompt-form").submit(function(o){o.preventDefault();l()});$("#address").keydown(function(o){if(o.keyCode==13){o.preventDefault();if($("#address-live li.highlighted").length){$("#address-live li.highlighted").trigger("click")}else{$("#position-prompt-submit").trigger("click")}}if(o.keyCode==38){o.preventDefault();if($("#address-live li.highlighted").length){before=$("#address-live li.highlighted").prev();if(before.length){$("#address-live li.highlighted").removeClass("highlighted");before.addClass("highlighted")}}}if(o.keyCode==40){o.preventDefault();if($("#address-live li.highlighted").length){next=$("#address-live li.highlighted").next();if(next.length){$("#address-live li.highlighted").removeClass("highlighted");next.addClass("highlighted")}}else{$("#address-live li").first().addClass("highlighted")}}});$("#position-prompt-form").focusout(function(){$("#address-live").fadeOut(250)});function n(o){j=o.response}function l(){h();$("#position-prompt-submit");$("#position-prompt .error").remove();$("#location-prompt-resultchoice").remove();var o=$("#address").val();if(!search_data.lat||!search_data.lon){$.get("/api/locations?l="+o,function(q){if(q.response.length){var p=q.response[0]["point"].split(",");search_data.lat=p[0];search_data.lon=p[1];location_string=q.response[0]["name"]+", ";if(q.response[0]["postalcode"]){location_string+=q.response[0]["postalcode"]+" "}location_string+=q.response[0]["bodyName"]+" ";$("#address").val(location_string);search_data.address=location_string;g(parseFloat(search_data.lat),parseFloat(search_data.lon));sessionParams={address:o,lat:search_data.lat,lon:search_data.lon};OpenRIS.session(sessionParams,n)}else{}})}else{g(parseFloat(search_data.lat),parseFloat(search_data.lon));sessionParams={address:o,lat:search_data.lat,lon:search_data.lon};OpenRIS.session(sessionParams,n)}}function k(){d.clearLayers()}function h(){k();b.setView(new L.LatLng(OpenRIS.region.lat,OpenRIS.region.lon),OpenRIS.region.zoom)}function c(o){o.preventDefault();f()}function f(){window.history.pushState(String(Date.now()),document.title,"/?r="+OpenRIS.region.id);$("#map-claim").remove();$("#position-prompt").show();$("#address").focus();$("#address").select();search_data={address:null};sessionParams={address:null,lat:null,lon:null};OpenRIS.session(sessionParams,n);h()}function g(y,q){var v=$("#address").val();if(v===""){v=j.location_entry}window.history.pushState(String(Date.now()),document.title,"/?r="+OpenRIS.region.id+'&l="'+v+'"');var r=$(document.createElement("span")).text(v).attr({id:"map-claim-street"});var z=$(document.createElement("a")).text("Neue Suche").attr({href:"#","class":"awesome extrawide"}).css("margin-left","20px").click(c);var x="";if(OpenRIS.endsWith(v,"straße")||OpenRIS.endsWith(v,"gasse")){x="die"}var t='<div id="map-claim"><span>Das passiert rund um '+x+" </span></div>";$("#position-prompt").slideUp().after(t);$("#map-claim").append(r).append(z);k();var B=new L.LatLng(y,q),w=500;b.setView(B,14);var A={color:"#97c66b",opacity:0.7,fill:false,draggable:true};var p=new L.Circle(B,w,A);var s=new L.Circle(B,20,{fillOpacity:0.9,fillColor:"#97c66b",stroke:false,draggable:true});var o=L.popup().setLatLng(B).setContent("<p>Dies ist der Suchmittelpunkt für die Umkreissuche.</p>");p.on("click",function(C){b.openPopup(o)});p.on("drag",function(C){console.log(C)});s.on("click",function(C){b.openPopup(o)});d.addLayer(p);d.addLayer(s);var u=[];OpenRIS.streetsForPosition(OpenRIS.region.id,y,q,w,function(C){$.each(C.response,function(D,E){if(E.paper_count){$.each(E.nodes,function(J,G){var H=[];$.each(G,function(M,K){H.push(new L.LatLng(K[1],K[0]))});var I='<p><b><a href="/suche?r='+OpenRIS.region.id+"&q=&quot;"+D+'&quot;">'+D+": "+E.paper_count+" Treffer</a></b>";if(E.paper_publishedDate&&E.paper_name){I+="<br/>Der jüngste Treffer vom "+OpenRIS.formatIsoDate(E.paper_publishedDate)+" ("+E.paper_name+")"}I+="</p>";var F=L.polyline(H,{color:"#ff0909"});F.bindPopup(I);d.addLayer(F)})}})})}$("#qinput-submit").click(function(o){o.preventDefault();$("#search-form").trigger("submit")});OpenRIS.loadPaperLiveSearch();$("<p>").attr("id","qinput-live").css({top:$("#qinput").height(),width:$("#qinput").width()}).appendTo($("#qinput-box"));$("#qinput").papersearchbox({url:"/api/papers-live?r="+OpenRIS.region.id,param:"p",show_results:function(o){o=o.response;result_html="<ul>";if(o.length){$("#qinput-live").css({display:"block"});for(i=0;i<o.length;i++){result_html+='<li data-q="'+o[i]["name"]+'">'+o[i]["name"]+" ("+o[i]["count"]+")</li>"}result_html+="</ul>";$("#qinput-live").html(result_html);$("#qinput-live li").click(function(){search_string=$(this).attr("data-q");$("#qinput").val(search_string);$("#qinput-submit").trigger("click")})}else{$("#qinput-live").css({display:"none"})}}});$("#qinput").keydown(function(o){if(o.keyCode==13){o.preventDefault();if($("#qinput-live li.highlighted").length){$("#qinput-live li.highlighted").trigger("click")}else{$("#qinput-submit").trigger("click")}}if(o.keyCode==38){o.preventDefault();if($("#qinput-live li.highlighted").length){before=$("#qinput-live li.highlighted").prev();if(before.length){$("#qinput-live li.highlighted").removeClass("highlighted");before.addClass("highlighted")}}}if(o.keyCode==40){o.preventDefault();if($("#qinput-live li.highlighted").length){next=$("#qinput-live li.highlighted").next();if(next.length){$("#qinput-live li.highlighted").removeClass("highlighted");next.addClass("highlighted")}}else{$("#qinput-live li").first().addClass("highlighted")}}})});